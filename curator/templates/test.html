<!doctype html>
<html>
  <head>
    <meta charset='utf=8'>

    <link href="/static/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css" />
    <link href="/static/stylesheets/print.css" media="print" rel="stylesheet" type="text/css" />
    <!--[if IE]>
      <link href="/static/stylesheets/ie.css" media="screen, projection" rel="stylesheet" type="text/css" />
    <![endif]-->
  </head>
  <body>

  <div id='blueprint'></div>
  <button id='load-more'>Load more</button>

<script type='text/javascript' src='/static/handlebars.js'></script>
<script type='text/javascript' src='/static/jquery.js'></script>
<script type='text/javascript' src='/static/underscore.js'></script>
<script type='text/javascript' src='/static/backbone.js'></script>
<script type='text/javascript' src='/static/sprintf.js'></script>

{% raw %}
<script type='text/html' id='blueprint_template'>
<header class='blueprint-header'>
  <h1>{{ name }}</h1>
</header>

<div class='reactions'></div>
</script>


<script type='text/html' id='reactant_template'>
  <div class='reactant'>{{ name }} <span class='stoichiometry'>{{{format_stoichiometry stoichiometry }}}</span></div>
</script>


<script type='text/html' id='product_template'>
  <div class='product'><span class='stoichiometry'>{{{format_stoichiometry stoichiometry }}}</span> {{ name }}</div>
</script>


<script type='text/html' id='reaction_template'>
  <header>
    <h1>{{ name }}</h1>
  </header>

  <div class='flux-diagram'>
    <div class='headers'>
      <div class='reactants-header'>Reactant <span class='stoichiometry'>Stoichiometry</span></div>
      <div class='flux-header'></div>
      <div class='products-header'><span class='stoichiometry'>Stoichiometry</span> Product</div>
    </div>

    <div class='data'>
      <div class='reactants'>
      </div>

      <div class='flux'>
      </div>
      <div class='products'>
      </div>
    </div>
  </div>
</script>
{% endraw %}

<script type='text/javascript'>

  var blueprint_template = Handlebars.compile($('#blueprint_template').html());
  var reactant_template = Handlebars.compile($('#reactant_template').html());
  var product_template = Handlebars.compile($('#product_template').html());
  var reaction_template = Handlebars.compile($('#reaction_template').html());

  // TODO collapse reaction flux diagram by default

  Handlebars.registerHelper('sprintf', sprintf);

  Handlebars.registerHelper('format_stoichiometry', function(s) {
    if (s < 0.001) {
      return '< 0.01';
    } else if (Math.floor(s) != s) {
      return sprintf('%.3f', s);
    } else {
      return s;
    }
  });

  var make_svg = function(tag) {
    return document.createElementNS('http://www.w3.org/2000/svg', tag);
  };

  // TODO handle resizing window, redraw svg flux paths
  var init_reaction = function($root) {

    var cont = $root.find('.flux');
    var cw = cont.width();
    var ch = cont.height();

    var svg = make_svg('svg');
    cont[0].appendChild(svg);

    svg.setAttribute('version', '1.2');
    svg.setAttribute('baseProfile', 'tiny');
    svg.setAttribute('viewBox', '0 0 ' + cw + ' ' + ch);
    svg.setAttribute('width', cw);
    svg.setAttribute('height', ch);

    var junc_h = 40;
    var junc_w = 100;

    var w = (cw - junc_w) / 2;

    var rect = make_svg('rect');
    rect.setAttribute('x', w);
    rect.setAttribute('y', 0);
    rect.setAttribute('width', junc_w);
    rect.setAttribute('height', junc_h);
    rect.setAttribute('class', 'flux-rect');

    svg.appendChild(rect);

    var init_flux_paths = function(elements, reverse) {

      var offset_l = 0;
      var offset_r = 0;

      var h_inc = junc_h / elements.length;

      elements.each(function(i, el) {

        var h = el.clientHeight;

        var d = ['M', 0, offset_l, 'L', w, offset_r, w, offset_r + h_inc, 
                 'L', 0, offset_l + h, 'Z'].join(' ');

        offset_r += h_inc;
        offset_l += h;

        var path = make_svg('path');
        path.setAttribute('d', d);

        if (reverse) {
          path.setAttribute('transform',
                            'translate(' + (cw + 1) + ', 0) scale(-1, 1)');
        }

        var cls = 'flux-path';
        if ($(el).hasClass('alternate')) {
          cls += ' alternate';
        }
        path.setAttribute('class', cls);

        // TODO sucks that i have to emulate jQuery.toggleClass() here
        $(el).hover(function() {
          path.setAttribute('class', path.getAttribute('class') + ' hover');
        }, function() {
          var cls = ' ' + path.getAttribute('class') + ' ';
          while (cls.indexOf(' hover ') > -1) {
            cls = cls.replace(' hover ', ' ');
          }
          path.setAttribute('class', cls);
        });

        $(path).hover(function() {
          $(el).toggleClass('hover');
        });

        svg.appendChild(path);
      });
    };

    init_flux_paths($root.find('.reactant'));

    init_flux_paths($root.find('.product'), true);

  };

  var api_base = 'http://127.0.0.1:8000';
  var Blueprint = Backbone.Model.extend({
    url: 'http://127.0.0.1:8000/api/v1/blueprint/1/?format=json'
  });

  var Reaction = Backbone.Model.extend({
  });

  var Species = Backbone.Model.extend({
  });


  var ReactionView = Backbone.View.extend({
    tagName: 'div',
    className: 'reaction',

    render: function() {
      var s = reaction_template(this.model.toJSON());
      this.$el.html(s);
      var that = this;

      _.each(this.model.get('reactants'), function(r, i) {
        var s = reactant_template({
          name: r.species.name,
          stoichiometry: r.stoichiometry,
        });

        var e = $(s);
        that.$el.find('.reactants').append(e);
      });

      _.each(this.model.get('products'), function(p, i) {

        var s = product_template({
          name: p.species.name,
          stoichiometry: p.stoichiometry,
        });

        var e = $(s);
        that.$el.find('.products').append(e);
      });

      init_reaction(this.$el);

      return this;
    }
  });

  var ReactionCollection = Backbone.Collection.extend({
    model: Reaction,
    url: 'http://127.0.0.1:8000/api/v1/reaction/?format=json&blueprint=1',
    next: '',
    parse: function(resp) {
      this.url = resp.meta.next;
      return resp.objects;
    },
  });

  var App = Backbone.View.extend({

    initialize: function() {

      var b = new Blueprint();
      b.fetch({
        success: function(b, resp) {

          var bv = $(blueprint_template(b.toJSON()));
          $('#blueprint').html(bv);

          // TODO bootstrap initial data

          var reactions = new ReactionCollection();

          var renderOne = function(m) {
            var v = new ReactionView({
              model: m,
            });
            $('#blueprint .reactions').append(v.el);
            v.render();
          };

          reactions.on('add', renderOne);

          reactions.on('reset', function() {

            $('#blueprint .reactions').html('');
            reactions.each(renderOne);
          });

          reactions.fetch();

          $('#load-more').click(function() {
            reactions.fetch({
              add: true
            });
          });
        }
      });
    },
  });

  var app = new App();
</script>

</body>
</html>
